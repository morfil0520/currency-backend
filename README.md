# Currency Backend

Асинхронный backend-сервис на **FastAPI** для работы с валютными данными.

Сервис реализует:
- REST API
- WebSocket для уведомлений в реальном времени
- фоновую задачу, получающую данные с внешнего сервиса через `httpx`
- интеграцию с брокером сообщений **NATS** (публикация и подписка)
- асинхронную работу с БД (SQLite + SQLAlchemy)

---

## Цель работы

Реализовать сервис, соответствующий формулировке задания:

**«Асинхронный Backend: REST API + WebSocket + Фоновая задача + NATS»**

---

## Соответствие требованиям задания

### 1) REST API

В проекте реализованы следующие endpoints:
- `GET    /items`        – получить список элементов
- `GET    /items/{id}`   – получить элемент по id
- `POST   /items`        – создать новый элемент
- `PATCH  /items/{id}`  – обновить элемент
- `DELETE /items/{id}`  – удалить элемент
- `POST   /tasks/run`   – принудительно запустить фоновую задачу

Все обработчики реализованы асинхронно (`async def`).  
Работа с базой данных также асинхронная (SQLite через SQLAlchemy + aiosqlite).

---

### 2) WebSocket `/ws/items`

Реализован WebSocket-эндпоинт:
- `WS /ws/items` — канал для real-time уведомлений.

Функциональность:
- клиент подключается к `/ws/items`
- получает сообщения в формате JSON:
  - о создании, обновлении и удалении элементов
  - о данных, полученных фоновой задачей
  - о событиях, поступивших из NATS
- рассылка сообщений осуществляется через менеджер WebSocket-подключений

---

### 3) Фоновая задача

Фоновая задача:
- автоматически запускается через заданный интервал времени
- выполняет HTTP-запрос к внешнему API с использованием `httpx`
- обрабатывает полученные данные
- сохраняет или обновляет данные в БД (SQLite)
- публикует событие в NATS (например, в канал `items.updates`)
- отправляет уведомления всем подключённым WebSocket-клиентам

Реализован ручной запуск фоновой задачи:
- `POST /tasks/run`

---

### 4) NATS

Интеграция с брокером сообщений **NATS** включает:
- использование асинхронного клиента (`asyncio-nats`)
- публикацию сообщений в канал `items.updates` при:
  - создании элемента
  - обновлении элемента
  - удалении элемента
  - выполнении фоновой задачи
- подписку на канал `items.updates`:
  - входящие сообщения логируются
  - при необходимости могут использоваться для обновления БД или уведомлений WebSocket

При недоступности NATS сервис продолжает работу (REST API, WebSocket и фоновые задачи), ошибки подключения логируются.

---

### 5) Асинхронная база данных
- База данных: **SQLite**
- Драйвер: `aiosqlite`
- ORM: **SQLAlchemy** (асинхронный engine и session)
- модели и Pydantic-схемы вынесены в отдельные модули

---

## Как запустить проект

### 1. Установка зависимостей

Находясь в корне проекта:

```bash
pip install -r requirements.txt
```

### 2. Запуск NATS (опционально)

Для проверки интеграции с брокером сообщений:

```bash
docker run -p 4222:4222 nats
```

Если NATS не запущен, сервис продолжит работу без обмена событиями.

### 3. Запуск приложения

```bash
uvicorn main:app --reload
```

После запуска:
Swagger UI: http://localhost:8000/docs
ReDoc: http://localhost:8000/redoc

## REST API (кратко)
	GET /items — список всех элементов (курсов)
	GET /items/{item_id} — получить элемент по id
	POST /items — создать новый элемент
	PATCH /items/{item_id} — обновить существующий элемент
	DELETE /items/{item_id} — удалить элемент
	POST /tasks/run — вручную запустить фоновую задачу

## WebSocket

Эндпоинт: `WS /ws/items`

Пример логики работы:

1. Клиент подключается к ws://localhost:8000/ws/items
2. При изменении данных или выполнении фоновой задачи сервер отправляет JSON-сообщения:
   - тип события (create / update / delete / background_task)
   - данные объекта или агрегированные значения.

---

## Фоновая задача

Фоновая задача:

- запускается автоматически по таймеру
- получает данные с внешнего API
- сохраняет/обновляет записи в SQLite
- публикует событие в NATS
- уведомляет WebSocket-клиентов

Ручной запуск:

- `POST /tasks/run`

---

## NATS

Канал, используемый для обмена событиями:

- например, `items.updates`.

Сервис:

- публикует события при изменениях данных
- подписывается на канал
- обрабатывает входящие сообщения
- при необходимости обновляет локальную БД или уведомляет клиентов

---

## Технологический стек

- FastAPI - фреймворк для создания API  
- httpx - асинхронный HTTP-клиент 
- NATS (asyncio-nats) - брокер сообщений  
- uvicorn - ASGI-сервер  
- SQLite - база данных  
- SQLAlchemy - асинхронный ORM  
- Pydantic - валидация данных 
- WebSockets - поддержка WebSocket в FastAPI
